# 一、api以及参数

### API介绍

#### 1、scan.createScan()

创建扫描的函数，并始终返回一个 curr_scan对象,

#### 2、curr_scan.destory()

释放所有资源，销毁scan

#### 3、curr_scan.nlp(option)

启动nlp分词查询，获取tts、翻译等内容

- option: 对象，成员如下：
  - content: string，需要查询的文本
  - segmentation: bool，是否需要切割分词，true表示需要，否则false
  - tts： bool，是否需要tts，同上
  - stream_tts: bool，是否需要流式tts，不需要则返回url，tts为true时有效
  - translation： bool，是否需要翻译，同上
  - dictionary： bool，是否需要查询词典，同上
  - stop：bool，如果为ture，以上所有字段无效，即为stop，缺省值为false，不写这个字段即为缺省值

#### 4、curr_scan.setSpeed(speed) 

设置tts语速，当前仅支持离线语速设置

- speed：设置的语速，范围0.7-1.2，若超过该范围则按边界值设置

#### 5、curr_scan.control(option)
控制ocr返回图片还是文字，默认为文字模式，不改变的话不需要调用此接口
- option对象，可选成员如下：
    - scan_mode:string，必选，text表示返回文字，img表示返回图片
    - path:string，img模式使用，jpeg保存路径，如/mnt/card/jpeg，文件夹不需要提前创建
    - num:int，img模式使用，拼接jpeg图片的数量，默认5张
    - end:int，img模式使用，拼接是否结束。0代表未结束，1代表结束。拼接了num张jpeg图片后会自动结束，若想中途结束可将该成员置1

注：提前结束不需要使用path和num成员

### curr_scan事件

当创建成功后，返回的curr_camera对象可通过 on 方法监听多个事件，业务逻辑可在监听的回调函数中完成。以下列举一些常用的事件：

- open

  ##### 笔头按下时被触发；

  ```
  curr_scan.on('open', function() {
    console.debug('open');
  })
  ```

- close

  ##### 笔头抬起时被触发

  ```
  curr_scan.on('close', function() {
    console.debug('close');
  })
  ```

- data

  ##### 摄像头数据推送事件，有数据时触发

  ###### 1、离线数据包格式

  ```
  //ocr包
  {"type":"text","result":{"index":1,"last_frame":0,"ocr2Text":"为什么有了进程还需要线程"}}
  //分词包 pwords.type: 1：标点符号， 0：词、短语、句子等
  {"type":"words","result":{"ocr2Text":"为什么有了进程还需要线程","pwords":[{"type":1,"w":"为什么"},]}}
  //tts包
  {"type":"tts","result":{"index":0,"ocr2TextTts":["http://tts.gurobot.cn/v1/audio/20230310/5423641000031b65/1678428298.mp3?type=101&sid=223"],"stream_data":"","stream_data_size":1}}
  //翻译包
  {"type":"translation","result":{"pwords":[],"translation":"Why do you need thread when you have a process? ","translationAudio":""}}
  ```

```
curr_scan.on('data', function(options, data_p) {
	console.debug('data');
	console.info('data info', options.len, options.last);
	console.info('data p', typeof(data_p), data_p);
})
```

下面形参解释 ：
\* Option对象中的属性值：
len: int 数据长度；
last: int 是否为最后一张；
\* data_p：数据指针；

### 在线扫读笔例子

```
var scan= require('scan');

var curr_scan= scan.createScan();

curr_scan.on('open', function() {
	console.debug('open');
})

curr_scan.on('close', function() {
	console.debug('close');
})

curr_scan.on('data', function(options, data_p) {
	console.debug('data');
	console.info('data info', options.len, options.last);
	console.info('data p', typeof(data_p), data_p);
})
```

### 离线扫读笔例子

```
var camera = require('scan');
var player = require('player');

var curr_scan = camera.createScan();
var mediaPlayer = player.createPlayer();


mediaPlayer.on('player_error', function(options) {
	console.debug('player_error cb');

});

mediaPlayer.on('player_start', function(options) {
	console.debug('player_start');
});

mediaPlayer.on('player_process', function(options) {
	console.debug('player_process:', typeof(options), options);
});

mediaPlayer.on('player_end', function(options) {
	console.debug('player_end');
});

var options = {
    name: "abcdef",
	audioInfo: {
		format: 'wav',
		channel: 1,
		bit: 16,
		samp: 16000,
	}
}

var nlp_option = {
	content: "",
	segmentation:true,
	tts: true,
	stream_tts: true,
	translation: true,
	dictionary: false,
	stop: false,
};

curr_scan.on('open', function() {
	mediaPlayer.stop();
	console.debug('open');
})

curr_scan.on('close', function() {
	console.debug('close');
})


function prase_json(str)
{
	var data = JSON.parse(str);
	console.log('type = ' + data.type);
	if (data.type == 'text') {
		if (data.result.last_frame) {
			console.log("ocr2Text = ", data.result.ocr2Text);
			nlp_option.content = data.result.ocr2Text;
			console.log("option = ", nlp_option);
			curr_scan.nlp(nlp_option);
		}
	} else if (data.type == 'tts') {
		if (data.result.index == 0) {
			mediaPlayer.play('this is a stream player', options);
		} else if (data.result.stream_data == null) {
			console.error("last frame");
			ret = mediaPlayer.putStream(null, 0);
		} else if (data.result.stream_data != '') {
			console.log('tts --------> data.result.index = ' + data.result.index);
			var buf = new Buffer(data.result.stream_data, "base64");
			console.log('buf.len = ', buf.length);
			var ret = mediaPlayer.putStream(buf, buf.length);
			console.log('n ret = ', ret);
		}
	} else if (data.type == 'words') {

	} else if (data.type == 'translation') {

	}
}

curr_scan.on('data', function(options, data_p) {
	prase_json(data_p.toString());
})
```